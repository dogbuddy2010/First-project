name: Daily Bug Scan - Turtle Project

on:
  schedule:
    # Run daily at 9:00 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch:  # Allow manual triggering
  push:
    branches:
      - main
      - master
    paths:
      - 'turtle_app.py'
      - '**/*.py'

jobs:
  bug-scan:
    runs-on: ubuntu-latest
    name: Scan Turtle Project for Bugs
    permissions:
      contents: read
      issues: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install pylint flake8 bandit
      
      - name: Run Flake8 (Style & Error Check)
        id: flake8
        run: |
          set -o pipefail
          echo "## Flake8 Results" >> $GITHUB_STEP_SUMMARY
          flake8 "turtle_app.py" --count --show-source --statistics --extend-ignore=E501 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          status=${PIPESTATUS[0]}
          echo "exit_code=$status" >> $GITHUB_OUTPUT
          if [ "$status" -eq 0 ]; then
            echo "âœ… Flake8 passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Flake8 found issues" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          exit 0
      
      - name: Run Pylint (Code Quality Check)
        id: pylint
        run: |
          set -o pipefail
          echo "## Pylint Results" >> $GITHUB_STEP_SUMMARY
          pylint "turtle_app.py" --fail-under=7.0 --disable=C0114,C0116 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          status=${PIPESTATUS[0]}
          echo "exit_code=$status" >> $GITHUB_OUTPUT
          if [ "$status" -eq 0 ]; then
            echo "âœ… Pylint passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Pylint found issues" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          exit 0
      
      - name: Run Bandit (Security Check)
        id: bandit
        run: |
          set -o pipefail
          echo "## Bandit Security Scan Results" >> $GITHUB_STEP_SUMMARY
          bandit "turtle_app.py" 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          status=${PIPESTATUS[0]}
          echo "exit_code=$status" >> $GITHUB_OUTPUT
          if [ "$status" -eq 0 ]; then
            echo "âœ… Bandit passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Bandit found issues" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          exit 0
      
      - name: Python Syntax Check
        id: syntax
        continue-on-error: true
        run: |
          set -o pipefail
          echo "## Syntax Check Results" >> $GITHUB_STEP_SUMMARY
          python -m py_compile "turtle_app.py" 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          status=${PIPESTATUS[0]}
          echo "exit_code=$status" >> $GITHUB_OUTPUT
          if [ "$status" -eq 0 ]; then
            echo "âœ… No syntax errors found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Syntax errors found" >> $GITHUB_STEP_SUMMARY
          fi
          exit 0
      
      - name: Create Issue if Bugs Found
        if: always() && (steps.flake8.outputs.exit_code != '0' || steps.pylint.outputs.exit_code != '0' || steps.bandit.outputs.exit_code != '0' || steps.syntax.outputs.exit_code != '0')
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸ› Daily Bug Scan - Issues Found in Turtle Project';
            const body = `## Bug Scan Report - ${new Date().toLocaleDateString()}
            
            The daily automated bug scan has detected issues in the Turtle project.
            
            Please review the workflow run for details:
            ${context.payload.repository.html_url}/actions/runs/${context.runId}
            
            ### Scan Results:
            - Flake8 (Style/Errors): exit code ${{ steps.flake8.outputs.exit_code }}
            - Pylint (Code Quality): exit code ${{ steps.pylint.outputs.exit_code }}
            - Bandit (Security): exit code ${{ steps.bandit.outputs.exit_code }}
            - Syntax Check: exit code ${{ steps.syntax.outputs.exit_code }}
            
            ---
            *This issue was automatically created by the daily bug scanning workflow.*`;
            
            // Check if there's already an open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'bug,automated-scan'
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('Daily Bug Scan')
            );
            
            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: body
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['bug', 'automated-scan']
              });
            }
      
      - name: Report Success
        if: always() && steps.flake8.outputs.exit_code == '0' && steps.pylint.outputs.exit_code == '0' && steps.bandit.outputs.exit_code == '0' && steps.syntax.outputs.exit_code == '0'
        run: |
          echo "âœ… All bug scans passed! No issues found." >> $GITHUB_STEP_SUMMARY
